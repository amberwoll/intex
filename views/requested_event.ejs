<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Requested Events</title>
    <style>
      table {
        width: 100%;
        margin: 20px auto;
        border-collapse: collapse;
        font-size: 12px;
      }
      th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
      }
      th {
        background-color: #f2f2f2;
        font-weight: bold;
      }
      button {
        padding: 4px 8px;
        margin: 2px;
        font-size: 12px;
        cursor: pointer;
      }
      h1 {
        text-align: center;
        margin: 20px 0;
      }
      .form-container {
        display: flex;
        justify-content: center;
        margin: 20px 0;
      }
    </style>
    <script>
      function handleFormSubmit(event, eventNumber) {
        event.preventDefault(); // Prevent the form from submitting normally
        const form = event.target;
        const statusId = form.querySelector('select[name="status_id"]').value;

        fetch(`/updateEventStatus/${eventNumber}`, {
          method: 'POST',
          body: new FormData(form),
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Show an alert to notify the user
            if (statusId === 'approved' || statusId === 'completed') {
              alert('Event marked as approved/completed! Please enter the status date below.');
              // Optionally, show the date input field if not already visible
              document.getElementById('date-input-section').style.display = 'block';
              // Store event number for later use
              document.getElementById('status_date_form').dataset.eventNumber = eventNumber;
            } else {
              location.reload(); // Reload the page to show the updated status
            }
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
      }

      function saveDate() {
        const form = document.getElementById('status_date_form');
        const eventNumber = form.dataset.eventNumber;
        const statusDate = form.querySelector('input[name="status_date"]').value;

        fetch(`/updateStatusDate/${eventNumber}`, {
          method: 'POST',
          body: JSON.stringify({ status_date: statusDate }),
          headers: { 'Content-Type': 'application/json' },
        })
        .then(response => {
          alert('Date saved successfully!');
          location.reload(); // Reload the page after saving the date
        })
        .catch(error => {
          console.error('Error:', error);
        });
      }
    </script>
  </head>
  <body>
    <h1>Requested Events</h1>
    <form action="/" method="GET">
      <button type="submit">Home</button>
    </form>
    <table>
      <thead>
        <tr>
          <th>Host</th>
          <th>Organization</th>
          <th>Event Description</th>
          <th>Street</th>
          <th>City</th>
          <th>State</th>
          <th>Zip</th>
          <th>Possible Date 1</th>
          <th>Possible Date 2</th>
          <th>Event Length</th>
          <th>Sewing Activity</th>
          <th>Number of Sewers</th>
          <th>Number of Non-Sewers</th>
          <th>Number of Children</th>
          <th>Machine</th>
          <th>Size of Space</th>
          <th>Jen Story</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <% if (requested_events.length > 0) { %>
          <% requested_events.forEach(requested_event => { %>
            <tr>
              <input type="hidden" value="requested_event.event_number">
              <td><%= requested_event.host %></td>
              <td><%= requested_event.organization %></td>
              <td><%= requested_event.event_description %></td>
              <td><%= requested_event.street %></td>
              <td><%= requested_event.city %></td>
              <td><%= requested_event.state %></td>
              <td><%= requested_event.zip %></td>
              <td><%= requested_event.possible_date_1 %></td>
              <td><%= requested_event.possible_date_2 %></td>
              <td><%= requested_event.event_length %></td>
              <td><%= requested_event.sewing_description %></td>
              <td><%= requested_event.number_of_sewers %></td>
              <td><%= requested_event.number_of_nonsewers %></td>
              <td><%= requested_event.number_of_children %></td>
              <td><%= requested_event.machine %></td>
              <td><%= requested_event.size_of_space %></td>
              <td><%= requested_event.jen_story %></td>
              <td>
                <form action="/updateEventStatus/<%= requested_event.event_number %>" method="POST" onsubmit="handleFormSubmit(event, <%= requested_event.event_number %>)">
                  <select id="status_id" name="status_id">
                    <% event_status.forEach(description => { %>
                      <option 
                        value="<%= description.status_id %>" 
                        <%= parseInt(requested_event.status_id, 10) === parseInt(description.status_id, 10) ? 'selected' : '' %>>
                        <%= description.status_description %>
                      </option>
                    <% }) %>
                  </select>
                  <button type="submit">Save</button>
                </form>                
              </td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="7">No data available</td>
          </tr>
        <% } %>
      </tbody>
    </table>

    <!-- Section for date input after status update -->
    <div id="date-input-section" style="display: none;">
      <h2>Enter the Date for Status Change</h2>
      <form id="status_date_form">
        <input type="date" name="status_date" required />
        <button type="button" onclick="saveDate()">Save Date</button>
      </form>
    </div>
  </body>
</html>
