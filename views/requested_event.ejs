<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Requested Events</title>
    <style>
      table {
        width: 100%;
        margin: 20px auto;
        border-collapse: collapse;
        font-size: 14px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
        line-height: 1.4;
      }
      th {
        background-color: #f9f9f9;
        font-weight: bold;
      }
      button {
        padding: 6px 12px;
        font-size: 14px;
        cursor: pointer;
        margin: 2px;
      }
      h1 {
        text-align: center;
        margin: 20px 0;
      }
      .form-buttons {
        display: flex;
        justify-content: center;
        margin: 20px 0;
      }
      .form-container {
        display: flex;
        justify-content: center;
        margin: 20px 0;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>Requested Events</h1>
    <table>
      <thead>
        <tr>
          <th>Host</th>
          <th>Organization</th>
          <th>Event Description</th>
          <th>Street</th>
          <th>City</th>
          <th>State</th>
          <th>Zip</th>
          <th>Possible Date 1</th>
          <th>Possible Date 2</th>
          <th>Event Length</th>
          <th>Sewing Activity</th>
          <th>Number of Sewers</th>
          <th>Number of Non-Sewers</th>
          <th>Number of Children</th>
          <th>Machine</th>
          <th>Size of Space</th>
          <th>Jen Story</th>
          <th>Status</th>
          <th>Chosen Event Start Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if (requested_events.length > 0) { %>
          <% requested_events.forEach(requested_event => { %>
            <tr data-status-id="<%= requested_event.status_id %>">
              <input type="hidden" value="<%= requested_event.event_number %>">
              <td><%= requested_event.host %></td>
              <td><%= requested_event.organization %></td>
              <td><%= requested_event.event_description %></td>
              <td><%= requested_event.street %></td>
              <td><%= requested_event.city %></td>
              <td><%= requested_event.state %></td>
              <td><%= requested_event.zip %></td>
              <td><%= requested_event.possible_date_1 %></td>
              <td><%= requested_event.possible_date_2 %></td>
              <td><%= requested_event.event_length %></td>
              <td><%= requested_event.sewing_description %></td>
              <td><%= requested_event.number_of_sewers %></td>
              <td><%= requested_event.number_of_nonsewers %></td>
              <td><%= requested_event.number_of_children %></td>
              <td><%= requested_event.machine %></td>
              <td><%= requested_event.size_of_space %></td>
              <td><%= requested_event.jen_story %></td>
              <form action="/updateEventStatus/<%= requested_event.event_number %>" method="POST">
                <td>
                  <select id="status_id_<%= requested_event.event_number %>" name="status_id">
                    <% event_status.forEach(description => { %>
                      <option 
                        value="<%= description.status_id %>" 
                        <%= parseInt(requested_event.status_id, 10) === parseInt(description.status_id, 10) ? 'selected' : '' %>>
                        <%= description.status_description %>
                      </option>
                    <% }) %>
                  </select>
                </td>
                <td>
                  <% if (requested_event.status_id === '1' || requested_event.status_id === '2') { %>
                    <% if (requested_event.event_start) { %>
                      <!-- If event_start exists, display it as text -->
                      <span><%= requested_event.event_start %></span>
                    <% } else { %>
                      <!-- If event_start doesn't exist, show the input field to allow editing -->
                      <input type="datetime-local" id="event_start_<%= requested_event.event_number %>" name="event_start" value="<%= requested_event.event_start %>" required>
                    <% } %>
                  <% } else { %>
                    <span>Only for completed or approved events</span>
                  <% } %>
                </td>      
                <td>
                  <% if (requested_event.status_id === '1' || requested_event.status_id === '2') { %>
                    <button type="submit">Save</button>
                  <% } else { %>
                    <button type="submit" disabled>Save</button>
                  <% } %>
                </td>
              </form>                
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="20">No data available</td>
          </tr>
        <% } %>
      </tbody>
    </table>

    <div class="form-buttons">
      <form action="/addRequestedEvent" method="GET">
        <button type="submit">Add New Event</button>
      </form>
      <form action="/" method="GET">
        <button type="submit">Home</button>
      </form>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const rows = document.querySelectorAll('tr[data-status-id]'); // Select all rows with the data-status-id attribute

        rows.forEach(row => {
          const statusId = row.getAttribute('data-status-id');
          const eventNumber = row.querySelector('input[type="hidden"]').value;
          const datePicker = row.querySelector(`#event_start_${eventNumber}`);
          const statusSelect = row.querySelector(`#status_id_${eventNumber}`);

          // Initialize date picker state based on initial status
          toggleDatePicker(statusId, datePicker);

          // Listen for changes to the status dropdown
          statusSelect.addEventListener('change', function() {
            const newStatusId = statusSelect.value;
            toggleDatePicker(newStatusId, datePicker);
          });

          function toggleDatePicker(statusId, datePicker) {
            // Enable or disable the date picker based on the status
            if (statusId === '1' || statusId === '2') {
              datePicker.disabled = false; // Enable if status is 'approved' or 'completed'
            } else {
              datePicker.disabled = true; // Disable for other statuses
            }
          }
        });
      });
    </script>
  </body>
</html>
